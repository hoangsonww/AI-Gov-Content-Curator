name: CI Pipeline AI Content Curator

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  formatting:
    name: "🔧 Format & Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install all workspaces
        run: npm ci

      - name: Run Prettier
        run: npm run format

      - name: Run ESLint
        run: npm run lint

  backend:
    name: "✅ Backend Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install backend deps
        run: npm --workspace backend ci

      - name: Run backend tests
        run: npm --workspace backend test

  crawler:
    name: "🤖 Crawler Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install crawler deps
        run: npm --workspace crawler ci

      - name: Run crawler tests
        run: npm --workspace crawler test

  newsletters:
    name: "✉️ Newsletters Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install newsletters deps
        run: npm --workspace newsletters ci

      - name: Run newsletters tests
        run: npm --workspace newsletters test

  frontend:
    name: "🌐 Frontend E2E"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install frontend deps
        run: npm --workspace frontend ci

      - name: Install Playwright browsers
        run: npm --workspace frontend exec playwright install --with-deps

      - name: Run frontend E2E
        run: npm --workspace frontend test:e2e
        continue-on-error: true

  complete:
    name: "🎉 All Required Tests Passed"
    runs-on: ubuntu-latest
    needs: [ backend, crawler, newsletters ]
    steps:
      - run: echo "✅ Backend, crawler & newsletters tests all passed; frontend E2E is best-effort."
