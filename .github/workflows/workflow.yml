name: CI Pipeline AI Content Curator

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  # provide dummy keys so chat & topic-extractor tests don’t blow up
  NEWS_API_KEY: dummy
  GOOGLE_AI_API_KEY: dummy

jobs:
  formatting:
    name: "🔧 Format & Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install all workspaces
        run: npm ci

      - name: Run Prettier
        run: npm run format

      - name: Run ESLint
        run: npm run lint

  backend:
    name: "✅ Backend Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install & Test Backend
        run: |
          npm --workspace backend ci
          npm --workspace backend test

  crawler:
    name: "🤖 Crawler Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # if crawler/package.json doesn’t list jest as a devDependency,
      # you can install it via the root:
      - name: Ensure Jest is available
        run: npm install --workspace crawler --save-dev jest ts-jest @types/jest

      - name: Run Crawler Tests
        run: |
          npm --workspace crawler test

  newsletters:
    name: "✉️ Newsletters Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install & Test Newsletters
        run: |
          npm --workspace newsletters ci
          npm --workspace newsletters test

  frontend:
    name: "🌐 Frontend E2E"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install & Run Frontend E2E
        run: |
          npm --workspace frontend ci
          npm --workspace frontend exec playwright install --with-deps
          npm --workspace frontend run test:e2e
        continue-on-error: true

  complete:
    name: "🎉 All Required Tests Passed"
    runs-on: ubuntu-latest
    needs: [ backend, crawler, newsletters ]
    steps:
      - run: echo "✅ Backend, crawler & newsletters tests all passed; frontend E2E is best-effort."
