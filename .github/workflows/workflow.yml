name: CI Pipeline AI Content Curator

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  formatting:
    name: "🔧 Format & Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Use Node 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install root deps
        run: npm ci

      - name: Prettier format
        run: npm run format

      - name: ESLint lint
        run: npm run lint

  backend:
    name: "✅ Backend Tests"
    runs-on: ubuntu-latest
    needs: formatting
    env:
      GOOGLE_AI_API_KEY: dummy
      GOOGLE_AI_API_KEY1: dummy
    steps:
      - uses: actions/checkout@v3

      - name: Use Node 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install backend deps
        run: npm --workspace backend ci

      - name: Run backend tests
        run: npm --workspace backend run test

  crawler:
    name: "🤖 Crawler Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install crawler deps
        run: npm --workspace crawler ci

      - name: Run crawler tests
        run: npm --workspace crawler run test

  newsletters:
    name: "✉️ Newsletters Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install newsletters deps
        run: npm --workspace newsletters ci

      - name: Run newsletters tests
        run: npm --workspace newsletters run test

  frontend:
    name: "🌐 Frontend E2E (allowed to fail)"
    runs-on: ubuntu-latest
    needs: formatting
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3

      - name: Use Node 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install frontend deps
        run: npm --workspace frontend ci

      - name: Install Playwright browsers
        run: npm --workspace frontend exec playwright install --with-deps

      - name: Run frontend E2E
        run: npm --workspace frontend run test:e2e

  complete:
    name: "🎉 All Required Tests Passed"
    runs-on: ubuntu-latest
    needs: [backend, crawler, newsletters]
    if: ${{ success() }}
    steps:
      - run: echo "✅ Formatting, linting, backend, crawler and newsletters tests all passed."
