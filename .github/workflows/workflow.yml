name: CI Pipeline AI Content Curator

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  formatting:
    name: "ğŸ”§ Format & Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install root deps
        run: npm ci

      - name: Prettier format
        run: npm run format

      - name: ESLint lint
        run: npm run lint

  backend:
    name: "âœ… Backend Tests"
    runs-on: ubuntu-latest
    needs: formatting
    env:
      # satisfy chat.controller tests
      GOOGLE_AI_API_KEY: dummy
      GOOGLE_AI_API_KEY1: dummy
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install backend deps
        run: npm --workspace backend ci

      - name: Run backend tests
        run: npm --workspace backend run test

  crawler:
    name: "ğŸ¤– Crawler Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install crawler deps
        run: npm --workspace crawler ci

      - name: Run crawler tests
        run: npm --workspace crawler run test

  newsletter:
    name: "âœ‰ï¸ Newsletter Tests"
    runs-on: ubuntu-latest
    needs: formatting
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install newsletter deps
        run: npm --workspace newsletter ci

      - name: Run newsletter tests
        run: npm --workspace newsletter run test

  frontend:
    name: "ğŸŒ Frontend Tests"
    runs-on: ubuntu-latest
    needs: formatting
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install frontend deps
        run: npm --workspace frontend ci

      - name: Run unit tests
        run: npm --workspace frontend run test:unit

      - name: Install Playwright deps
        run: npm --workspace frontend exec playwright install --with-deps

      - name: Run e2e tests
        run: npm --workspace frontend run test:e2e

  complete:
    name: "ğŸ‰ All Required Tests Passed"
    runs-on: ubuntu-latest
    needs: [backend, crawler, newsletter]
    if: ${{ success() }}
    steps:
      - run: echo "âœ… Formatting, linting, backend, crawler and newsletter tests all passed."
